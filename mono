#!/bin/sh

# New-look `bouncer', adapted to use the `telnet loads.mono.org' output.

# A few user options for friendliness. -screen will start the client within
# `screen'; -ssh will use ssh instead of telnet for the connection itself.
# -nopty will use ssh in a way that avoids allocating a pseudo-terminal.
# In addition, you can override the automatic machine selection by picking
# your own on the command line.
SCREEN=
MACH=
TERMSTUFF=
EXEC=exec
FILTER=
CONNECT='telnet -l mono'
unset CEND
stty quit ^^
if test -f $HOME/.mfilter; then FILTER=$HOME/.mfilter; fi
while [ $# -gt 0 ]; do
  case "$1" in
    -screen) SCREEN='screen -ln';;
    -ssh) EXEC=exec; CONNECT='sh -c '\''eval "set -- $SSHOPTS" && exec ssh -C -x -e none -l mono "$@"'; CEND="'";;
    -nopty) EXEC=; CONNECT='stty -isig -icanon -echo; cat | ssh -C -x -e none -l mono';
            CEND='; stty isig icanon echo'; unset exec ;;
    -nofilter) FILTER= ;;
    -telnet) EXEC=exec; CONNECT='telnet -l mono';;
    -term) TERMSTUFF=$2; shift;;
    -*) echo "Unknown option $1" ;;
    *) MACH=$1;;
  esac
  shift
done

# Invent new TERM variable
case "$TERMSTUFF" in
  '') NEWTERM="$TERM";;
  /*) NEWTERM="$TERM$TERMSTUFF";;
  *) NEWTERM="$TERMSTUFF";;
esac

# Check if a machine is supplied
case "$MACH" in
  '' ) if test -f $HOME/.monomach; then
         MACH=`cat $HOME/.monomach`
	 MACHINE=`echo $MACH | sed -e 's/\.mono\.org$//; s/\([a-z]\)$/\1.mono.org/'`
	 echo "Machine $MACHINE read from ~/.monomach."
       fi;;
  *) MACHINE=`echo $MACH | sed -e 's/\.mono\.org$//; s/\([a-z]\)$/\1.mono.org/'`
     echo "Machine $MACHINE supplied on command line." ;;
esac

if [ "$MACHINE" = "" ]; then
  echo "Retrieving machine list..."
  tmpfile=/tmp/bouncer.$$.`date +%Y%m%d%H%M%S`
  telnet loads.mono.org > $tmpfile 2>&1
  MACHINE=`awk 'BEGIN {l=-2}/^HOSTS$/ { l=NR } NR==l+1 && NF==2 { print $1 }' $tmpfile`
  case $MACHINE in
    *.i.mono.org)
      echo "CORRECTING FOR WEIRD INTERNAL MACHINE NAME!"
      MACHINE=`echo $MACHINE | sed 's/i\.mono\.org/mono\.org/'`
      ;;
  esac
  if test -n "$MACHINE"; then
    echo "Lowest-loaded machine is $MACHINE."
  else
    echo "Unable to get a machine name."
    MACHINE=NOLOGIN
  fi
fi

if [ "a$MACHINE" != "aNOLOGIN" ]
then
  rm -f $tmpfile
  echo "Connecting to $MACHINE."
  $SCREEN sh -c \
    "echo -ne '\033[?7l'; TERM=$NEWTERM $EXEC $FILTER $CONNECT $MACHINE $CEND"
  echo -ne '\033[?7h'
else
  echo "Cannot currently get a machine name. This may be due to downtime,"
  echo "or a bug in the bouncer script, or confusion."
  if [ "$VERBOSE" = "yes" ]; then
    echo ""
    echo "The output from 'telnet loads.mono.org' was as follows:"
    cat $tmpfile
  fi
  rm -f $tmpfile
fi
