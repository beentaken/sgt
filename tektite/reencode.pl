#!/usr/bin/perl

%encodings = (
    "ISO8859-1" => [ # really ISO8859-1 plus vt100 line drawing
        ["C000", 0, 32],
        ["C001", 1, 9830],
        ["C002", 2, 9618],
        ["C003", 3, 9225],
        ["C004", 4, 9228],
        ["C005", 5, 9229],
        ["C006", 6, 9226],
        ["C007", 7, 176],
        ["C010", 8, 177],
        ["C011", 9, 9252],
        ["C012", 10, 9227],
        ["C013", 11, 9496],
        ["C014", 12, 9488],
        ["C015", 13, 9484],
        ["C016", 14, 9492],
        ["C017", 15, 9532],
        ["C020", 16, 9146],
        ["C021", 17, 9147],
        ["C022", 18, 9472],
        ["C023", 19, 9148],
        ["C024", 20, 9149],
        ["C025", 21, 9500],
        ["C026", 22, 9508],
        ["C027", 23, 9524],
        ["C030", 24, 9516],
        ["C031", 25, 9474],
        ["C032", 26, 8804],
        ["C033", 27, 8805],
        ["C034", 28, 960],
        ["C035", 29, 8800],
        ["C036", 30, 163],
        ["C037", 31, 183],
        ["space", 32, 32],
        ["exclam", 33, 33],
        ["quotedbl", 34, 34],
        ["numbersign", 35, 35],
        ["dollar", 36, 36],
        ["percent", 37, 37],
        ["ampersand", 38, 38],
        ["apostrophe", 39, 39],
        ["parenleft", 40, 40],
        ["parenright", 41, 41],
        ["asterisk", 42, 42],
        ["plus", 43, 43],
        ["comma", 44, 44],
        ["minus", 45, 45],
        ["period", 46, 46],
        ["slash", 47, 47],
        ["0", 48, 48],
        ["1", 49, 49],
        ["2", 50, 50],
        ["3", 51, 51],
        ["4", 52, 52],
        ["5", 53, 53],
        ["6", 54, 54],
        ["7", 55, 55],
        ["8", 56, 56],
        ["9", 57, 57],
        ["colon", 58, 58],
        ["semicolon", 59, 59],
        ["less", 60, 60],
        ["equal", 61, 61],
        ["greater", 62, 62],
        ["question", 63, 63],
        ["at", 64, 64],
        ["A", 65, 65],
        ["B", 66, 66],
        ["C", 67, 67],
        ["D", 68, 68],
        ["E", 69, 69],
        ["F", 70, 70],
        ["G", 71, 71],
        ["H", 72, 72],
        ["I", 73, 73],
        ["J", 74, 74],
        ["K", 75, 75],
        ["L", 76, 76],
        ["M", 77, 77],
        ["N", 78, 78],
        ["O", 79, 79],
        ["P", 80, 80],
        ["Q", 81, 81],
        ["R", 82, 82],
        ["S", 83, 83],
        ["T", 84, 84],
        ["U", 85, 85],
        ["V", 86, 86],
        ["W", 87, 87],
        ["X", 88, 88],
        ["Y", 89, 89],
        ["Z", 90, 90],
        ["bracketleft", 91, 91],
        ["backslash", 92, 92],
        ["bracketright", 93, 93],
        ["asciicircum", 94, 94],
        ["underscore", 95, 95],
        ["grave", 96, 96],
        ["a", 97, 97],
        ["b", 98, 98],
        ["c", 99, 99],
        ["d", 100, 100],
        ["e", 101, 101],
        ["f", 102, 102],
        ["g", 103, 103],
        ["h", 104, 104],
        ["i", 105, 105],
        ["j", 106, 106],
        ["k", 107, 107],
        ["l", 108, 108],
        ["m", 109, 109],
        ["n", 110, 110],
        ["o", 111, 111],
        ["p", 112, 112],
        ["q", 113, 113],
        ["r", 114, 114],
        ["s", 115, 115],
        ["t", 116, 116],
        ["u", 117, 117],
        ["v", 118, 118],
        ["w", 119, 119],
        ["x", 120, 120],
        ["y", 121, 121],
        ["z", 122, 122],
        ["braceleft", 123, 123],
        ["bar", 124, 124],
        ["braceright", 125, 125],
        ["asciitilde", 126, 126],
        ["C177", 127, 127],
        ["nobreakspace", 160, 160],
        ["exclamdown", 161, 161],
        ["cent", 162, 162],
        ["sterling", 163, 163],
        ["currency", 164, 164],
        ["yen", 165, 165],
        ["brokenbar", 166, 166],
        ["section", 167, 167],
        ["diaeresis", 168, 168],
        ["copyright", 169, 169],
        ["ordfeminine", 170, 170],
        ["guillemotleft", 171, 171],
        ["notsign", 172, 172],
        ["hyphen", 173, 173],
        ["registered", 174, 174],
        ["macron", 175, 175],
        ["degree", 176, 176],
        ["plusminus", 177, 177],
        ["twosuperior", 178, 178],
        ["threesuperior", 179, 179],
        ["acute", 180, 180],
        ["mu", 181, 181],
        ["paragraph", 182, 182],
        ["periodcentered", 183, 183],
        ["cedilla", 184, 184],
        ["onesuperior", 185, 185],
        ["masculine", 186, 186],
        ["guillemotright", 187, 187],
        ["onequarter", 188, 188],
        ["onehalf", 189, 189],
        ["threequarters", 190, 190],
        ["questiondown", 191, 191],
        ["Agrave", 192, 192],
        ["Aacute", 193, 193],
        ["Acircumflex", 194, 194],
        ["Atilde", 195, 195],
        ["Adiaeresis", 196, 196],
        ["Aring", 197, 197],
        ["AE", 198, 198],
        ["Ccedilla", 199, 199],
        ["Egrave", 200, 200],
        ["Eacute", 201, 201],
        ["Ecircumflex", 202, 202],
        ["Ediaeresis", 203, 203],
        ["Igrave", 204, 204],
        ["Iacute", 205, 205],
        ["Icircumflex", 206, 206],
        ["Idiaeresis", 207, 207],
        ["ETH", 208, 208],
        ["Ntilde", 209, 209],
        ["Ograve", 210, 210],
        ["Oacute", 211, 211],
        ["Ocircumflex", 212, 212],
        ["Otilde", 213, 213],
        ["Odiaeresis", 214, 214],
        ["multiply", 215, 215],
        ["Ooblique", 216, 216],
        ["Ugrave", 217, 217],
        ["Uacute", 218, 218],
        ["Ucircumflex", 219, 219],
        ["Udiaeresis", 220, 220],
        ["Yacute", 221, 221],
        ["THORN", 222, 222],
        ["ssharp", 223, 223],
        ["agrave", 224, 224],
        ["aacute", 225, 225],
        ["acircumflex", 226, 226],
        ["atilde", 227, 227],
        ["adiaeresis", 228, 228],
        ["aring", 229, 229],
        ["ae", 230, 230],
        ["ccedilla", 231, 231],
        ["egrave", 232, 232],
        ["eacute", 233, 233],
        ["ecircumflex", 234, 234],
        ["ediaeresis", 235, 235],
        ["igrave", 236, 236],
        ["iacute", 237, 237],
        ["icircumflex", 238, 238],
        ["idiaeresis", 239, 239],
        ["eth", 240, 240],
        ["ntilde", 241, 241],
        ["ograve", 242, 242],
        ["oacute", 243, 243],
        ["ocircumflex", 244, 244],
        ["otilde", 245, 245],
        ["odiaeresis", 246, 246],
        ["division", 247, 247],
        ["oslash", 248, 248],
        ["ugrave", 249, 249],
        ["uacute", 250, 250],
        ["ucircumflex", 251, 251],
        ["udiaeresis", 252, 252],
        ["yacute", 253, 253],
        ["thorn", 254, 254],
        ["ydiaeresis", 255, 255],
    ],
);

$enc = shift @ARGV;
($registry, $encoding) = split '-', $enc;
die "unknown encoding '$enc'\n" unless defined $encodings{$enc};
@enc = @{$encodings{$enc}};

$file = shift @ARGV;
open BDF, "<", $file or die "$file: open: $!\n";

# Copy the BDF header, except for replacing the encoding.
while (<BDF>) {
    if (/^(\s*FONT "?.*-)[^-]*-[^-"]*("?)$/) { print "$1$enc$2\n"; next; } 
    if (/^(\s*CHARSET_REGISTRY )/) { print "$1\"$registry\"\n"; next; }
    if (/^(\s*CHARSET_ENCODING )/) { print "$1\"$encoding\"\n"; next; }
    if (/^\s*CHARS /) { last; }
    print;
}

# Read the char definitions.
%chars = ();
while (<BDF>) {
    if (/^\s*STARTCHAR /) {
        $char = "";
    } elsif (/^\s*ENCODING (\d+)/) {
        $code = $1;
    } else {
        $char .= $_;
        if (/^\s*ENDCHAR/) {
            $chars{$code} = $char;
        }
    }
}

close BDF;

printf "CHARS %d\n\n", scalar @enc;
for $e (@enc) {
    ($name, $newenc, $oldenc) = @$e;
    printf "STARTCHAR %s\nENCODING %d\n%s\n", $name, $newenc, $chars{$oldenc};
}
print "ENDFONT\n";
