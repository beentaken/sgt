<html>
<head>
<title>Filigrams: A New Type of Pretty Picture</title>
</head>
<link rel="stylesheet" type="text/css" href="../sitestyle.css" name="Simon Tatham's Home Page Style">
<body>
<h1 align=center>Filigrams: A New Type of Pretty Picture</h1>

<p>
<i>by <a href="../">Simon Tatham</a>, mathematician and programmer</i>
</p>

<h2>Introduction</h2>

<p>
Filigrams are a type of pretty pictures generated by mathematical
means. They're not technically a type of fractal, although they
contain elements which people who know fractals might find
hauntingly familiar. They're something I invented by accident once
and decided to polish up because it looked pretty.
</p>

<h2>Genesis</h2>

<p>
I produced the first filigram completely by mistake. When I was 14
or so, my GCSE Computer Studies teacher showed me a short BASIC
program on a BBC Micro that plotted a pleasant repeating pattern of
interlocking circles:

<p align=center>
<a href="circles.jpeg"><img src="circles.jpeg" alt="[320x256 greyscale JPEG, 40KB]" width=320 height=256></a>

<p>
I thought it was pretty enough that I should take the program home
and run it on my Amiga, where I could give it the benefit of better
graphics and see how much prettier it looked then.

<p>
So I memorised the important details of the program and went home to
a real computer. Completely by accident, I got one character wrong
when I typed the program back in, and it generated this instead:

<p align=center>
<a href="original.jpeg"><img src="original.jpeg" alt="[320x256 greyscale JPEG, 40KB]" width=320 height=256></a>

<p>
Now that's <em>much</em> more interesting than interlocking circles,
isn't it? It's got clear structure at the centre - black fades to
white and jumps back to black again, repeatedly, in narrower and
narrower stripes. Then, once the stripes become smaller than the
distance between pixels, the delicate filigree (hence the name)
degenerates into chaos. But beyond that, as if by magic, the chaos
reforms into a new order, with little butterfly shapes embedded in
the swirling black and white maelstrom. I stared at this feast of
interlocking detail and was very glad I'd typed the circles formula
in wrong. Then I set about enlarging it to poster size, so I could
print it out and put it on my wall.

<p>
Unfortunately, the pattern proved to be elusive. The way it was
generated provided an obvious way of magnifying it: the program was
computing a function at every point of a square grid, so to enlarge
it you just compute the same function at some new points in between
the original points, right? Wrong - if you try that, a lot of the
interesting detail in the butterfly shapes just disappears. Some of
it remains, but more and more of the detail disappears the further
you enlarge the image. It was like trying to nail fog to the wall -
at 320x256 resolution, the image obediently sat there and looked
pretty, but as soon as I looked any closer it vanished. Infuriating.

<p>
And there the matter rested for nearly ten years, until one day,
after having done a maths degree, I remembered it and came back to
see if I could finally find a way to catch that fog and nail it
down.
</p>

<h2>Analysis</h2>

<p>
(Warning to non-mathematicians: this section may get a little
intense. But there are pretty pictures to look at, so that's all
right :-)

<p>
The formula I'd completely failed to type correctly was the obvious
"circular" formula: <code>x^2+y^2</code>. The program I saw computed
the fractional part of this function at every point on the screen
and converted it to a colour value. This produces an N-colour image
of interlocking circles, and the pattern ends up repeating itself
after long enough. Instead of this, though, I replaced the addition
with a multiplication: <code>x^2*y^2</code>, with its fractional
part taken, generates the picture shown above.

<p>
So that explains the central section: each stripe in the centre
follows a line along which <code>x*y</code> is constant. Based on
this level of understanding, I was able to replace the function with
the slightly more complex <code>(2x+y)(2x-y)(x+2y)(x-2y)</code>,
which produces a nice symmetric cross shape at the centre:

<p align=center>
<a href="newfunc.jpeg"><img src="newfunc.jpeg" alt="[320x256 greyscale JPEG, 44KB]" width=320 height=256></a>

<p>
But we still haven't explained the butterflies - and I knew that I
would have to understand what the butterflies were if I were to
avoid them disappearing when magnified. So when I came back to the
problem nearly ten years later, I looked at it with the eyes of a
much more highly trained mathematician, and was finally able to see
far enough into the chaos to pin down the cause of the butterflies.

<p>
The reason the central section of the image has such smooth changes
of colour is that the values of <code>f(x,y)</code> don't vary by
much over the distance between pixels. But out in the butterfly
regions, <code>f(x,y)</code> is growing much faster than that; so
why are those butterflies appearing? Answer: it must be because the
difference in <code>f(x,y)</code> between one pixel and the next is
very <em>close</em> to an integer - so that the difference in the
<em>fractional</em> part of <code>f(x,y)</code> is very small even
though the actual values of <code>f</code> differ by a lot. And
that's why half the butterflies disappear when you enlarge the image
by a factor of two: when the difference in <code>f</code> between
two pixels is close to an <em>odd</em> integer, then the fractional
part of <code>f</code> half-way between the two pixels will be about
<code>1/2</code> away from what it was at the original pixels
themselves - as different as it's possible to be. No wonder the
butterflies disappeared so easily.

<p>
So at the centre of every butterfly, the fractional part of
<code>f(x,y)</code> is close to the fractional part of
<code>f(x+1,y)</code>, and <em>also</em> close to the fractional
part of <code>f(x,y+1)</code>. In other words - and here's where the
calculus begins - the partial derivatives of <code>f</code> with
respect to <code>x</code> and <code>y</code> are both integers at
the centre of each butterfly. (Well, actually they're integer
multiples of the reciprocal of the inter-pixel spacing; but it
obscures the essence of the mathematics to have to keep remembering
about the inconvenient constants. Putting the correct constants back
in is left as an exercise for the reader :-)

<p>
This also suggests that if we plot the lines along which the partial
derivatives <code>df/dx</code> and <code>df/dy</code> are equal to
an integer and a <em>half</em>, we might well find ourselves drawing
a set of lines that precisely mark the divisions <em>between</em>
the butterflies. And it's true: we get the following picture. (The
partial derivatives in <code>x</code> and <code>y</code> are
<code>16*x^3-34*x*y^2</code> and <code>16*y^3-34*y*x^2</code>
respectively. Black lines mark contours of <code>df/dx</code>; red
lines mark contours of <code>df/dy</code>.)

<p align=center>
<a href="divisions.jpeg"><img src="divisions.jpeg" alt="[320x256 black-red-white JPEG, 32KB]" width=320 height=256></a>

<p>
(Notice in the above graph that the contours of the derivatives have
a three-fold symmetry. These three-way symmetric curves can clearly
be seen by following the lines of butterflies in the original image;
at first sight they seem a bit odd because the function being
plotted is <em>four</em>-way symmetric, right? But it does make
sense: the positions of the butterflies depend on the
<em>derivatives</em> of the degree-4 polynomial we started with,
which are degree-3 polynomials and can therefore indeed be expected
to be three-way symmetric.)

<p>
Now we're getting closer. With the above piece of analysis to help
us, we can isolate each butterfly and treat it separately.

<p>
For a moment, let's pretend this whole thing is only happening in
one dimension, instead of two. Consider the situation at the centre:
the value of <code>f</code> itself varies very little between
pixels, so computing the halfway point between two pixels will
produce a value that still fits in sensibly with the ones around it.
No problem.

<p>
Now consider the situation in a butterfly region. The difference in
<code>f</code> between two adjacent pixels is close to an integer,
let's say <code>a</code>. So <code>f(x+1)=f(x)+a+e</code>, where
<code>e</code> is the error term. Therefore, we would expect the
halfway point to be <code>f(x)+a/2+e'</code>, where <code>e'</code>
is comparable to <code>e</code>. More generally, <code>f(x+b)</code>
(where <code>b</code> is between 0 and 1) can be expected to be
<code>f(x)+ab+e(b)</code>. So this gives what seems like a sensible
way to plot a point whose coordinates are fractional. To plot the
point at <code>x+b</code>, compute the nearest integer
<code>g</code> to the partial derivative at <code>x</code>; then
compute <code>f(x+b)</code> as normal, but subtract <code>b*g</code>
before taking the fractional part.

<p>
And this works! Returning to two dimensions, it still works. Every
clearly defined butterfly in the original image holds together when
viewed at higher resolution. Let's enlarge the image above by a
factor of two to prove it:

<p align=center>
<a href="enlarged.jpeg"><img src="enlarged.jpeg" alt="[640x512 greyscale JPEG, 156KB]" width=640 height=512></a>

<p>
To summarise, the algorithm for enlarging the image is as follows.

<ul>
<li>
For each pixel <code>(X,Y)</code> in the enlarged image, convert its
coordinates to coordinates <code>(x,y)</code> in the original image.
Save the fractional part <code>(xf,yf)</code> of each resulting
coordinate.

<li>
Compute the partial derivatives <code>(fx,fy)</code> of the function
at the point <code>(x,y)</code>, rounded to the nearest integer.

<li>
Compute the value of the function <code>f(x,y)</code>. Subtract the
product of each partial derivative with the fractional part of the
corresponding coordinate, to get <code>f(x,y)-fx*xf-fy*yf</code>.

<li>
Take the fractional part of that, and convert it into a pixel colour.
</ul>

<h2>Metamorphosis</h2>

<p>
After doing all of this, I made a further discovery. The original
function <code>x^2*y^2</code>, and the replacement
<code>(2x+y)(2x-y)(x+2y)(x-2y)</code> that I then switched to, are
both products of real linear factors. What happens, I wonder, when
you try using a polynomial <em>without</em> real factors?

<p>
So I tried it, of course. I replaced the function
<code>(2x+y)(2x-y)(x+2y)(x-2y)</code> with the alternative function
<code>(2x+iy)(2x-iy)(x+2iy)(x-2iy)</code> (which of course
multiplies out to a real polynomial, since the factors come in
conjugate pairs). The result was qualitatively different from the
other images:

<p align=center>
<a href="complex.jpeg"><img src="complex.jpeg" alt="[320x256 greyscale JPEG, 42KB]" width=320 height=256></a>

<p>
Suddenly we're getting circle shapes instead of butterfly shapes!
In retrospect, this makes reasonable sense: you get a circle shape
when the function is locally shaped like a paraboloid - curving
upwards on all sides, or downwards on all sides - and a butterfly
shape when the function is locally saddle-shaped, curving upwards in
one direction and downwards in the perpendicular direction. By
choosing polynomials with real factors, it seems I inadvertently
also chose functions which were saddle-shaped everywhere.

<p>
This is very nice; what happens when we try a function with
<em>some</em> real factors? So I tried the polynomial
<code>y(2x-iy)(2x+iy)</code> ... and <em>this</em> happened.

<p align=center>
<a href="semicomplex.jpeg"><img src="semicomplex.jpeg" alt="[320x256 greyscale JPEG, 43KB]" width=320 height=256></a>

<p>
Isn't that something? Butterflies in parts of the plot, circles in
other parts - and some <em>really</em> fun things, like small fish
shapes, happening where the two meet.

<p>
We can work out which type of feature we expect to see in which
parts of the plane, by applying a bit more calculus: given a twice
partially differentiable function <code>f(x,y)</code>, a few hours
of intense thought will tell you that the double partial derivatives
can be combined into the formula <code>(d2f/dxdy)^2&nbsp;-
(d2f/dx2)(d2f/dy2)</code>, and that this is greater than zero in
saddle-shaped regions and less than zero in circle-shaped regions.
(Also, this formula only varies by a positive constant factor when
you change the axes on the diagram, so it's a genuine reliable way
to tell.) But this doesn't seem to help with the pretty pictures -
it just gives us a useful tool to analyse them with.
</p>

<h2>Synthesis</h2>

<p>
So that's the heavy-duty maths over with. We're now able to take the
original simple <code>fractionalpart(f(x,y))</code> plots, and
enhance them into high-resolution images that can be fed to a
seriously high quality printer to generate eye-twisting posters. But
that isn't the end of it: some of the by-products of the algorithm
above can be used to produce some more fun effects.

<p>
In particular, when the partial derivatives above are rounded to the
nearest integer, it's instructive to note the amount by which each
derivative had to change when rounded. This will be close to zero
(in both directions) at the centre of each butterfly, close to
one-half (in both directions) at the corner between four
butterflies, and close to one-half (in only one direction) on the
edge between two butterflies. So we could take the maximum of the
fractional part of each partial derivative and use it to fade the
butterflies out at the edges:

<p align=center>
<a href="faded.jpeg"><img src="faded.jpeg" alt="[320x256 greyscale JPEG, 32KB]" width=320 height=256></a>

<p>
Also, keeping the integer parts of the partial derivatives provides
a good way to differentiate one butterfly from the next by changing
the colour. Here's what happens if we colour each butterfly purple
or green depending on whether the sum of the integer parts of the
partial derivatives is even or odd (this looks a bit strange unless
the fading effect is used at the same time):

<p align=center>
<a href="coloured.jpeg"><img src="coloured.jpeg" alt="[320x256 full-colour JPEG, 20KB]" width=320 height=256></a>
</p>

<h2>Downloads</h2>

<p>
A program to generate filigrams is available for download
<a href="filigram.c">here</a>. The program is
provided as C source code - you'll need a C compiler in order to use
it. For Windows users, Borland provide a C compiler for
free-of-charge download, on their web site at
<a href="http://www.borland.com/bcppbuilder/freecompiler/">www.borland.com</a>.

<p>
The program produces its output as Windows 24-bit .BMP files. Most
image processing software should be able to convert these to other
formats for you.

<p>
Here's a selection of sample command lines you might like to try:

<ul>
<li>
<code>filigram -o cross.bmp -s 640x512 -I 0.03125 -p 4x4-17x2y2+4y4
-x 10 -O 0.015625</code>
<br>
This one is the "standard" image that I've been using as an example
in the above discussion.

<li>
<code>filigram -o accident.bmp -s 640x512 -I 0.025 -p x2y2 -x
8</code>
<br>
This one is the original image that I generated by accident.

<li>
<code>filigram -o circles.bmp -s 640x512 -I 0.025 -p x2+y2 -x 8 -O
4</code>
<br>
This is the pattern of interlocking circles that I was
<em>trying</em> to generate when I created the above accident. The
formula is so similar that the same program will generate it!

<li>
<code>filigram -o complex.bmp -s 640x512 -I 0.03125 -p 4x4+17x2y2+4y4
-x 10 -O 0.015625</code>
<br>
This is the image with circle shapes instead of butterflies, created
using a polynomial with no real linear factors. The parameters are
<em>exactly</em> the same as the ones for <code>cross.bmp</code>
above, except for one crucial plus sign replacing a minus sign in
the polynomial.

<li>
<code>filigram -o fish.bmp -s 640x512 -I 0.03125 -p 4x2y+y3
-x 10 -O 0.5</code>
<br>
This is the image with some circle shapes, some butterflies, and
strange fish shapes where the two meet. This one behaves
interestingly when separate regions are coloured differently: it
turns out that the "head" and the "tail" of each fish shape are not
separate regions as far as the partial derivatives are concerned,
but are actually one combined feature.
</ul>

<p>
To add colour effects to any of the above pictures, try putting
these extra options on the end of the command line:

<ul>
<li>
<code>-f -c 0.7,0,1:0,0.63,0</code>
<br>
This gives a purple-and-green checkerboard effect.

<li>
<code>-f -c 2+0.61,0.0,0.0:0.48,0.0,0.56:0.82,0.64,0.0:0.0,0.7,0.0</code>
<br>
This gives coloured stripes across the images, in jewel colours.

<li>
<code>-f -c 1,0,0:1,1,0:0,1,0:0,1,1:0,0,1:1,0,1</code>
<br>
This gives a diagonal rainbow stripe effect.

<li>
<code>-f -c 1,1,1:0,0,0</code>
<br>
This causes half the features in the picture to turn black and
disappear completely! Perhaps it might help spice up an otherwise
boring picture...

<li>
<code>-f -c 0,0.4,1:0,0.7,0.5</code>
<br>
This gives a combination of sea-blue and sea-green which might go
will with the shapes in <code>fish.bmp</code> :-)
</ul>

<p>
To generate a bigger version of any of those images, change the
image size specification after the "<code>-s</code>" option.

<p>
Here are a few bigger (800x600) images I generated myself. All these
are in JPEG format, and each is about 100Kb.
<br>
<a href="checkers.jpeg">[checkers]</a>
<a href="rainbow.jpeg">[rainbow]</a>
<a href="jewels.jpeg">[jewels]</a>
<a href="wormhole.jpeg">[wormhole]</a>
<a href="deepsea.jpeg">[deepsea]</a>
</p>

<hr>
(comments to <a href="mailto:&#97;&#110;&#97;&#107;&#105;&#110;&#64;&#112;&#111;&#98;&#111;&#120;&#46;&#99;&#111;&#109;">&#97;&#110;&#97;&#107;&#105;&#110;&#64;&#112;&#111;&#98;&#111;&#120;&#46;&#99;&#111;&#109;</a>)
<br>
(thanks to
<a href="http://www.chiark.greenend.org.uk/">chiark</a>
for hosting this page)
<br>
(last modified on <!--LASTMOD-->[insert date here]<!--END-->)
</body>
</html>
