# -*- sh -*-
# Build script for making Tweak release archives.

module tweak

# We need the `library' module checked out alongside this one, for
# btree.[ch].
ifexist tweak/library in . do mv tweak/library library
ifnexist library checkout library library

# Make symlinks for those source files.
in tweak do ln -s ../library/btree.c .
in tweak do ln -s ../library/btree.h .

# Determine the version number.
set Version $(!builddate).$(vcsid)
ifneq $(RELEASE) "" set Version $(RELEASE)

# Put versionids into the docs. (Use perl to avoid inconsistent
# behaviour of echo '\v'.)
in tweak do perl -e 'print "\n\\versionid tweak version $$ARGV[0]\n"' $(Version) >> manpage.but
in tweak do perl -e 'print "\n\\versionid tweak version $$ARGV[0]\n"' $(Version) >> btree.but

# Fiddle with tweak.h to include the version number. Note use of $#
# to escape a hash sign from the build script lexer.
in tweak do perl -i~ -pe 's/(?<=$#define VER ")(?=")/$(Version)/' tweak.h

# Make the release archive.
in tweak do make release VERSION=$(Version)

# And deliver it.
deliver tweak/tweak-$(Version).tar.gz $@
