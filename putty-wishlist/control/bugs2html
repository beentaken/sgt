#! /usr/bin/perl
# $Id: bugs2html,v 1.4 2002/05/06 13:41:34 ben Exp $

use FileHandle;
use POSIX;

$bugdir = "../data";
$htmldir = "/u2/bjharris/public-html/putty-wishlist";
$baseurl = "/~sgtatham/putty";

open(INDEX, "> $htmldir/index.html") or die "$htmldir/index.html: $!";
print INDEX <<EOH;
<HTML><HEAD>
<TITLE>PuTTY Known Bugs and Wish List</TITLE>
</HEAD>
<link rel="stylesheet" type="text/css" href="sitestyle.css" name="PuTTY Home Page Style">
<BODY>
<h1 align=center>PuTTY Known Bugs and Wish List</h1>

<p align=center>
<a href="$baseurl/">Home</a> |
<a href="$baseurl/licence.html">Licence</a> |
<a href="$baseurl/faq.html">FAQ</a> |
<a href="$baseurl/docs.html">Docs</a> |
<a href="$baseurl/download.html">Download</a> |
<a href="$baseurl/keys.html">Keys</a><br>
<a href="$baseurl/mirrors.html">Mirrors</a> |
<a href="$baseurl/maillist.html">Updates</a> |
<a href="$baseurl/feedback.html">Feedback</a> |
<a href="$baseurl/changes.html">Changes</a> |
<b>Wishlist</b></p>

<p>
This is the list of bugs that need fixing, and features that want
adding, to PuTTY. This list represents things that have not been
done to the current <em>development</em> code. If you do not see a
feature here, it's worth checking the
<a href="$baseurl/changes.html">Changes page</a>
before mailing us to ask for the feature; we might have already
added it since the last release.
EOH

foreach $bugfile (glob("$bugdir/*")) {
    next unless -f $bugfile;
    open(BF, "< $bugfile") or die "$bugfile: $!";
    input_record_separator BF undef;
    $data = <BF>;
    close BF;
    ($bugname) = $bugfile =~ m{([^/]*)$};
    ($hdr, $body) = $data =~ /^(.*?\n)\n(.*)$/s;
    $hdr =~ s/\n\s+/ /g;
    @hdrs = split /\n/, $hdr;
    %hdrs = map { /^(\S*?):\s*(.*)$/; (lc $1, $2) } @hdrs;
    bug2html($bugname, \%hdrs, $body);
    $index{$hdrs{class}} .=
	qq[<li><a href="$bugname.html">$bugname: $hdrs{summary}</a>\n];
}

print INDEX <<EOF if $index{'bug'};
<a name="bugs"><h2>Bugs</h2></a>

<p>
These items are clearly actual problems and I want them fixed.
<ul>
$index{'bug'}
</ul>
EOF

print INDEX <<EOF if $index{'semi-bug'};
<h2>Semi-bugs</h2>

<p>
These are things which might be bugs or might not, depending on your
precise definition of what a bug is.

<ul>
$index{'semi-bug'}
</ul>
EOF

print INDEX <<EOF if $index{'wish'};
<h2>Wishlist</h2>

<p>
These are things that have been requested by users or which seem to me like
a good idea.  Not all of these are likely to be implemented without outside
help, and some of them will positively never be implemented.

<ul>
$index{'wish'}
</ul>
EOF

print INDEX <<EOF;
</ul>
<p><hr>Comments to
<a href="mailto:putty\@projects.tartarus.org">putty\@projects.tartarus.org</a>
<br>
(generated by bugs2html at
@{[POSIX::strftime("%a, %d %b %Y, %H:%M:%S %Z", gmtime)]})
</BODY></HTML>
EOF

close INDEX;

sub bug2html {
    my($bugname, $hdrs, $body) = @_;

    open(HTML, "> $htmldir/$bugname.html") or die "$htmldir/$bugname.html: $!";
    print HTML <<EOH;
<HTML><HEAD>
<TITLE>PuTTY @{[$hdrs->{class}]} $bugname</TITLE>
</HEAD>
<link rel="stylesheet" type="text/css" href="sitestyle.css" name="PuTTY Home Page Style">
<BODY>
<h1 align=center>PuTTY @{[$hdrs->{class}]} $bugname</h1>

<p align=center>
<a href="$baseurl/">Home</a> |
<a href="$baseurl/licence.html">Licence</a> |
<a href="$baseurl/faq.html">FAQ</a> |
<a href="$baseurl/docs.html">Docs</a> |
<a href="$baseurl/download.html">Download</a> |
<a href="$baseurl/keys.html">Keys</a><br>
<a href="$baseurl/mirrors.html">Mirrors</a> |
<a href="$baseurl/maillist.html">Updates</a> |
<a href="$baseurl/feedback.html">Feedback</a> |
<a href="$baseurl/changes.html">Changes</a> |
<b><a href="index.html">Wishlist</a></b></p>

EOH

    foreach $h (keys %$hdrs) {
	next if $h eq "content-type";
	print HTML qq[<b>$h</b>: @{[$hdrs->{$h}]}<br>\n];
    }

    if ($hdrs->{'content-type'} =~ "^text/x-html-body") {
	print HTML $body;
    } else {
	$body =~ s/&/&amp;/g;
	$body =~ s/</&lt;/g;
	$body =~ s/>/&gt;/g;
	print HTML qq[<p><pre>$body</pre>];
    }

    print HTML <<EOF;
<p><a href="http://cvs.tartarus.org/putty-wishlist/data/$bugname">
Audit trail</a> for this @{[$hdrs->{class}]}.
<hr>Comments to
<a href="mailto:putty\@projects.tartarus.org">putty\@projects.tartarus.org</a>
<br>
(generated by bugs2html at
@{[POSIX::strftime("%a, %d %b %Y, %H:%M:%S %Z", gmtime)]})
</BODY></HTML>
EOF

    close(HTML);
}
