Summary: Data transfer during SSH2 KEX causes confusion
Class: bug
Priority: medium
Difficulty: tricky
Content-type: text/x-html-body

<p>If there is data being transferred through PuTTY while the SSH2
repeat key exchange is taking place, it can confuse some servers.
As far as I'm aware nobody has properly standardised this aspect of
the SSH2 protocol (what happens to the connection layer while the
transport layer is in a key exchange phase?) so it isn't clear what
PuTTY <em>should</em> do in this situation, but a good
conservative/liberal option would be to accept incoming
connection-layer packets provided we can decrypt them, and to queue
outgoing connection-layer packets until the key exchange is
completed. I can't easily imagine a standards decision that would
invalidate that behaviour.

<p>
There has been some discussion of this issue on
<a href="ftp://ftp.ietf.org/ietf-mail-archive/secsh/">IETF SECSH</a>
(see for instance the thread "Key Re-Exchange" starting on 4 Apr 2001),
but no consensus appears to have been reached.

<p>
Symptoms of this:
<a href="http://www.ssh.com/products/ssh/">ssh.com</a>'s server, which
does repeat key exchange every hour or so, will sometimes throw you
off - a common disconnect message seems to be "Protocol error:
Received 94 as newkeys". (We've also had a report of "packet too long"
from F-Secure.) This will seem intermittent.

<p>
There aren't any really satisfactory workarounds - either using SSH-1
or disabling key re-exchange will both work, but have obvious
drawbacks.
